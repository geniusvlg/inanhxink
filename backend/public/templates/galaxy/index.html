<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Planet</title>
    <link rel="icon" type="image/x-icon" href="assets/images/planet.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <!-- Dynamic data from backend via /api/site-data -->
    <script>
        // Stub Firebase and socket.io (not needed in template view)
        window.io = function() { return { on: function(){}, emit: function(){}, disconnect: function(){} }; };
        window.firebase = {
            apps: [],
            initializeApp: function() { return {}; },
            auth: function() { return { onAuthStateChanged: function(cb) { cb(null); }, signOut: function() { return Promise.resolve(); } }; }
        };

        // Use a stable fake galaxy ID so sphere.js triggers its #id= loading path
        var FAKE_GALAXY_ID = '000000000000000000000001';
        if (!window.location.hash || window.location.hash === '#') {
            history.replaceState(null, '', '#id=' + FAKE_GALAXY_ID);
        }

                // Intercept sphere.js's fetch to /api/galaxy-configs/site
        // and redirect it to our backend's /api/site-data endpoint instead.
        var _origFetch = window.fetch;
        window.fetch = function(url) {
            var rest = [].slice.call(arguments, 1);
            if (typeof url === 'string' && url.indexOf('/api/galaxy-configs/') !== -1) {
                // On localhost pass ?sub= so the backend knows which record to load
                var sub = window.__SUBDOMAIN__ || '';
                var siteDataUrl = '/api/site-data' + (sub ? '?sub=' + sub : '');
                // Fetch personalised config from our backend
                return _origFetch.call(window, siteDataUrl)
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        var config = (data && data.template_data) ? data.template_data : {};
                        return new Response(
                            JSON.stringify({ success: true, config: config }),
                            { status: 200, headers: { 'Content-Type': 'application/json' } }
                        );
                    });
            }
            // Block payment / voucher API calls
            if (typeof url === 'string' && (
                url.indexOf('/api/vouchers') !== -1 ||
                url.indexOf('/api/products') !== -1
            )) {
                return Promise.resolve(new Response(
                    JSON.stringify({ success: false }),
                    { status: 200, headers: { 'Content-Type': 'application/json' } }
                ));
            }
            return _origFetch.apply(this, [url].concat(rest));
        };
    </script>

    <script src="js/exif.js"></script>

    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: Arial, sans-serif; }
        canvas { display: block; width: 100vw !important; height: 100vh !important; position: absolute; top: 0; left: 0; z-index: 1; }
        .stars-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,255,255,0.8) 1px, transparent 1px); background-size: 10px 10px; z-index: 0; animation: twinkle 4s infinite; }
        @keyframes twinkle { 0%,100% { opacity: .5; } 50% { opacity: .9; } }
        .hidden { display: none !important; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%,100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: .8; } }
    </style>
</head>
<body>
    <canvas id="canvas" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:10;pointer-events:none;"></canvas>
    <div class="stars-bg"></div>

    <!-- Help panel -->
    <div class="help-panel">
        <div class="controls-header" style="display:flex;justify-content:space-between;align-items:center;">
            <h3 class="help-title" style="margin:0;">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
            <button class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="help-section">
            <div class="section-divider"><h4>ƒêi·ªÅu khi·ªÉn c∆° b·∫£n</h4></div>
            <ul>
                <li><span class="label-pc">[PC]</span> Click ƒë√∫p chu·ªôt: Ph√°t nh·∫°c &amp; k√≠ch ho·∫°t hi·ªáu ·ª©ng camera</li>
                <li><span class="label-pc">[PC]</span> ‚Üë ·∫§n ph√≠m m≈©i t√™n l√™n: B·∫≠t/T·∫Øt hi·ªáu ·ª©ng bay v√≤ng ·∫£nh</li>
                <li><span class="label-mobile">[Mobile]</span> ·∫§n 2 l·∫ßn: Ph√°t nh·∫°c &amp; k√≠ch ho·∫°t hi·ªáu ·ª©ng camera</li>
                <li><span class="label-mobile">[Mobile]</span> ·∫§n icon h·ªôp qu√†: B·∫≠t/T·∫Øt hi·ªáu ·ª©ng bay v√≤ng ·∫£nh</li>
            </ul>
        </div>
        <div class="help-section">
            <div class="section-divider"><h4>ƒêi·ªÅu ch·ªânh g√≥c nh√¨n</h4></div>
            <ul>
                <li>Click &amp; k√©o: Xoay camera</li>
                <li>Cu·ªôn chu·ªôt: Ph√≥ng to/thu nh·ªè</li>
                <li>Mobile: Vu·ªët ƒë·ªÉ xoay, ch·ª•m/t√°ch ƒë·ªÉ zoom</li>
            </ul>
        </div>
    </div>

    <button class="google-login-btn hidden" id="googleLoginBtn"><i class="fab fa-google"></i></button>
    <div id="userLogoContainer" style="display:none;"></div>
    <div id="userDropdown" style="display:none;"></div>
    <div class="help-icon"><i class="fas fa-question-circle"></i></div>

    <!-- Quick help: Mobile -->
    <div class="quick-help-panel mobile-help" id="mobileQuickHelp">
        <div class="quick-help-header">
            <h3>üì± H∆∞·ªõng d·∫´n Mobile</h3>
            <button class="quick-help-close-btn" onclick="closeQuickHelp('mobile')"><i class="fas fa-times"></i></button>
        </div>
        <div class="quick-help-content">
            <div class="quick-help-section"><h4>üì∑ Hi·ªáu ·ª©ng Camera</h4><p>·∫§n 2 l·∫ßn v√†o m√†n h√¨nh ƒë·ªÉ k√≠ch ho·∫°t</p></div>
            <div class="quick-help-section"><h4>üå∏ Hi·ªáu ·ª©ng bay v√≤ng ·∫£nh</h4><p>·∫§n v√†o "icon h·ªôp qu√†" ƒë·ªÉ b·∫≠t/t·∫Øt</p></div>
            <div class="quick-help-section"><h4>‚òÑÔ∏è M∆∞a sao bƒÉng</h4><p>T·ª± ƒë·ªông b·∫≠t khi thi√™n h√† c√≥ t√≠nh nƒÉng n√†y</p></div>
            <div class="quick-help-section"><h4>üéÆ ƒêi·ªÅu khi·ªÉn camera</h4><p>Vu·ªët ƒë·ªÉ xoay, ch·ª•m/t√°ch ƒë·ªÉ ph√≥ng to/thu nh·ªè</p></div>
        </div>
    </div>

    <!-- Quick help: Desktop -->
    <div class="quick-help-panel desktop-help" id="desktopQuickHelp">
        <div class="quick-help-header">
            <h3>üíª H∆∞·ªõng d·∫´n Desktop</h3>
            <button class="quick-help-close-btn" onclick="closeQuickHelp('desktop')"><i class="fas fa-times"></i></button>
        </div>
        <div class="quick-help-content">
            <div class="quick-help-section"><h4>üì∑ Hi·ªáu ·ª©ng Camera</h4><p>Click ƒë√∫p chu·ªôt ƒë·ªÉ k√≠ch ho·∫°t</p></div>
            <div class="quick-help-section"><h4>üå∏ Hi·ªáu ·ª©ng bay v√≤ng ·∫£nh</h4><p>‚Üë ·∫§n ph√≠m m≈©i t√™n l√™n ƒë·ªÉ b·∫≠t/t·∫Øt</p></div>
            <div class="quick-help-section"><h4>‚òÑÔ∏è M∆∞a sao bƒÉng</h4><p>T·ª± ƒë·ªông b·∫≠t khi thi√™n h√† c√≥ t√≠nh nƒÉng n√†y</p></div>
            <div class="quick-help-section"><h4>üéÆ ƒêi·ªÅu khi·ªÉn camera</h4><p>Click v√† k√©o ƒë·ªÉ xoay, cu·ªôn chu·ªôt ƒë·ªÉ ph√≥ng to/thu nh·ªè</p></div>
        </div>
    </div>

    <button id="gift-btn" class="gift-btn" title="Hi·ªáu ·ª©ng bay v√≤ng ·∫£nh">
        <img src="assets/images/gift.gif" alt="Gift" style="width:28px;height:28px;vertical-align:middle;">
    </button>
    <button id="letter-btn" class="letter-btn" title="Hi·ªáu ·ª©ng th∆∞ t√¨nh">
        <img src="assets/images/letter.gif" alt="Letter" style="width:28px;height:28px;vertical-align:middle;">
    </button>

    <script>
        (function() {
            var hash = window.location.hash;
            document.body.classList.add((hash.indexOf('#config=') === 0 || hash.indexOf('#id=') === 0) ? 'web-con' : 'web-cha');
        })();

        function isMobileDevice() {
            var ua = navigator.userAgent;
            return /mobi|android|iphone|ipad|ipod|windows phone/i.test(ua) ||
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1) ||
                   (navigator.platform === 'Win32' && navigator.maxTouchPoints > 1);
        }
        function updateGiftBtnVisibility() {
            var giftBtn = document.getElementById('gift-btn');
            var letterBtn = document.getElementById('letter-btn');
            if (!giftBtn) return;
            var mobile = isMobileDevice();
            var tabletLandscape = window.innerWidth > 1024 && window.innerWidth <= 1380 && window.innerHeight < window.innerWidth;
            var surface = navigator.platform === 'Win32' && navigator.maxTouchPoints > 1;
            var hideOnDesktop = ((window.innerWidth > 1025 && window.innerHeight > window.innerWidth) || (window.innerWidth > 1380)) && !surface;
            giftBtn.style.display = hideOnDesktop ? 'none' : (mobile || tabletLandscape || surface ? 'block' : 'none');
            if (letterBtn) {
                var hash = window.location.hash;
                if (hash.indexOf('#config=') === 0 || hash.indexOf('#id=') === 0) {
                    letterBtn.style.display = hideOnDesktop ? 'none' : (mobile || tabletLandscape || surface ? 'block' : 'none');
                } else {
                    letterBtn.style.display = 'none';
                }
            }
        }
        document.addEventListener('DOMContentLoaded', updateGiftBtnVisibility);
        window.addEventListener('resize', updateGiftBtnVisibility);
        window.addEventListener('orientationchange', updateGiftBtnVisibility);
    </script>

    <!-- Loading overlay -->
    <div id="flower-loading-overlay" style="display:block;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.9);backdrop-filter:blur(12px);z-index:999999;pointer-events:none;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#fff;font-family:Arial,sans-serif;">
            <div style="margin-bottom:30px;">
                <img src="assets/images/planet.png" alt="Love Planet" style="width:60px;height:60px;filter:drop-shadow(0 0 10px rgba(255,107,107,0.5));animation:pulse 2s ease-in-out infinite;">
            </div>
            <div style="width:60px;height:60px;border:4px solid rgba(255,255,255,0.2);border-top:4px solid #ff6b6b;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 25px;"></div>
            <div style="font-size:24px;font-weight:700;margin-bottom:15px;background:linear-gradient(45deg,#ff6b6b,#ffd93d);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Love Planet</div>
            <div style="font-size:18px;font-weight:500;margin-bottom:10px;">ƒêang t·∫£i thi√™n h√†...</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.7);">Vui l√≤ng ch·ªù trong gi√¢y l√°t</div>
        </div>
    </div>

    <audio id="bg-audio" style="display:none"></audio>

    <script src="js/meteors.js"></script>
    <script src="bundle.js"></script>

    <div id="flower-toast" style="position:fixed;bottom:32px;left:50%;transform:translateX(-50%);background:rgba(30,30,30,0.92);color:#fff;font-size:13px;padding:7px 18px;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.12);z-index:9999;opacity:0;transition:opacity 0.2s;pointer-events:none;"></div>
</body>
</html>
